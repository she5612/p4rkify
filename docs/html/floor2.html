<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Floor 2 - Parking Slots</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700;900&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
/* --- Root Variables (Neon/Glow colors) --- */
:root {
    --primary-color: #00e5ff;
    --accent-color: #4de5ff;
    --background-start: #1c265c;
    --background-end: #0077b6;
    --text-light: #f0f0f0;
    --text-dark: #0f172a;
    --status-available: #69f0ae;
    --status-reserved: #ffee58;
    --status-occupied: #ff1744;
}
* { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
body { min-height:100vh; display:flex; justify-content:center; align-items:flex-start; padding:20px 10px;
    background:linear-gradient(135deg, var(--background-start), var(--background-end)); color:var(--text-light); }
body::before, body::after { content:''; position:absolute; border-radius:50%; filter:blur(100px); z-index:0; }
body::before { top:5%; left:10%; width:250px; height:250px; background: rgba(0,229,255,0.3); }
body::after { bottom:5%; right:10%; width:300px; height:300px; background: rgba(28,38,92,0.4); }

.glass-page-wrapper { position:relative; z-index:10; width:95%; max-width:1000px; padding:35px 30px; border-radius:25px;
    background: rgba(255,255,255,0.08); border:1px solid rgba(0,229,255,0.2); backdrop-filter:blur(15px);
    -webkit-backdrop-filter:blur(15px); box-shadow:0 10px 40px rgba(0,0,0,0.4); margin-top:20px; }

.title { font-family:'Orbitron',sans-serif; font-size:clamp(2rem,6vw,2.8rem); margin:0 0 35px; padding-bottom:15px;
    font-weight:700; text-align:center; color:var(--primary-color);
    text-shadow:0 0 15px rgba(0,229,255,0.8),0 0 5px rgba(0,229,255,0.5); letter-spacing:2px;
    border-bottom:1px solid rgba(0,229,255,0.3); }

.slots-container { width:100%; margin:0 auto; display:grid; gap:15px; justify-content:center;
    grid-template-columns: repeat(auto-fit, minmax(90px, 1fr)); }

.slot-card { height:90px; border-radius:10px; font-weight:600; transition: all 0.3s cubic-bezier(0.25,0.8,0.25,1);
    background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.15); backdrop-filter:blur(10px);
    box-shadow:0 4px 15px rgba(0,0,0,0.3); display:flex; flex-direction:column; justify-content:center; align-items:center;
    padding:8px; color:var(--text-light); user-select:none; }

.slot-card h3 { font-size:clamp(0.9rem,3vw,1.2rem); font-family:'Orbitron',sans-serif; color:var(--text-light);
    text-shadow:0 0 5px var(--primary-color); line-height:1.1; margin-bottom:2px; }

.slot-card p { font-size:clamp(0.55rem,1.5vw,0.75rem); font-weight:400; margin:0; text-transform:uppercase; letter-spacing:1px; }

.status-icon { font-size:1.1rem; margin-bottom:2px; text-shadow:0 0 8px currentColor; }

.slot-available { background:var(--status-available); color:var(--text-dark); border:1px solid var(--status-available);
    box-shadow:0 0 10px 2px var(--status-available); animation:pulseGlow 1.5s infinite alternate; cursor:pointer; }
.slot-available:hover { background:var(--accent-color); border-color:var(--primary-color); transform:scale(1.05); box-shadow:0 0 20px 4px var(--primary-color); animation:none; }

.slot-reserved { background:var(--status-reserved); color:var(--text-dark); border:1px solid var(--status-reserved);
    box-shadow:0 0 8px 1px var(--status-reserved); opacity:0.85; }
.slot-occupied { background:var(--status-occupied); color:var(--text-light); border:1px solid var(--status-occupied);
    box-shadow:0 0 8px 1px var(--status-occupied); opacity:0.7; }
.slot-reserved:hover, .slot-occupied:hover { transform:none; cursor:not-allowed; }

.countdown { font-size:0.7rem; font-weight:700; margin-top:2px; color:var(--text-dark); }

@keyframes pulseGlow { 0% { box-shadow:0 0 8px 2px var(--status-available); } 100% { box-shadow:0 0 16px 4px var(--status-available); } }

#custom-confirm-modal { transition:opacity 0.3s ease; }
#custom-confirm-modal > div { animation:popIn 0.3s ease-out; background:#0d122b; padding:30px; border-radius:15px; box-shadow:0 0 30px var(--primary-color);
    color:var(--text-light); max-width:90%; min-width:280px; text-align:center; border:2px solid var(--primary-color); }
#custom-confirm-modal button { transition:background-color 0.2s, transform 0.1s; }
#custom-confirm-modal #confirm-yes { background:#1de9b6; color:var(--text-dark); }
#custom-confirm-modal #confirm-yes:hover { background:#00e676; transform:translateY(-1px); }
#custom-confirm-modal #confirm-no { background:#ff5252; color:white; }
#custom-confirm-modal #confirm-no:hover { background:#ff1744; transform:translateY(-1px); }

@keyframes popIn { 0% { opacity:0; transform:scale(0.9); } 100% { opacity:1; transform:scale(1); } }
@media (max-width:600px){.title{font-size:1.6rem;margin-bottom:25px;}.glass-page-wrapper{padding:20px 15px;}}
</style>
</head>
<body>
<div class="glass-page-wrapper">
<h1 class="title">Floor 2 - Select Your Parking Slot üöó</h1>
<div id="slotsContainer" class="slots-container"></div>
</div>

<script type="module">
// --- Custom Modal & Message Helpers ---
function showMessage(message,type='info'){const box=document.createElement('div');box.textContent=message;box.style.cssText=`position:fixed;bottom:20px;left:50%;transform:translateX(-50%);padding:12px 20px;border-radius:8px;z-index:10000;font-weight:600;color:var(--text-dark);background-color:${type==='error'?'#ff1744':'#00e5ff'};box-shadow:0 4px 15px rgba(0,0,0,0.3);transition:all 0.5s ease-in-out;opacity:0;font-family:'Inter',sans-serif;`;document.body.appendChild(box);setTimeout(()=>{box.style.opacity=1;},10);setTimeout(()=>{box.style.opacity=0;box.addEventListener('transitionend',()=>box.remove());},3000);}
function showConfirmModal(message){return new Promise(resolve=>{let modal=document.getElementById('custom-confirm-modal');if(modal) modal.remove();modal=document.createElement('div');modal.id='custom-confirm-modal';modal.style.cssText=`position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);display:flex;justify-content:center;align-items:center;z-index:20000;backdrop-filter:blur(8px);`;const content=document.createElement('div');content.style.cssText=`background:#0d122b;padding:30px;border-radius:15px;box-shadow:0 0 30px var(--primary-color);color:var(--text-light);max-width:90%;min-width:280px;text-align:center;font-family:'Inter',sans-serif;`;content.innerHTML=`<p style="font-size:1.1rem;margin-bottom:25px;line-height:1.5;">${message}</p><button id="confirm-yes" style="padding:10px 20px;margin:0 8px;background:#1de9b6;color:var(--text-dark);border:none;border-radius:8px;cursor:pointer;font-weight:700;transition:all 0.2s;">Yes</button><button id="confirm-no" style="padding:10px 20px;margin:0 8px;background:#ff5252;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:700;transition:all 0.2s;">No</button>`;modal.appendChild(content);document.body.appendChild(modal);document.getElementById('confirm-yes').onclick=()=>{modal.remove();resolve(true);};document.getElementById('confirm-no').onclick=()=>{modal.remove();resolve(false);};});}

// --- Firebase Imports ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getDatabase, ref, update, push, set, serverTimestamp, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

// --- Firebase Config ---
const firebaseConfig={apiKey:"AIzaSyDWoFHHXKxEMBk-ZhZgYstPV6fylL8SLiE",authDomain:"parkifycapstone.firebaseapp.com",databaseURL:"https://parkifycapstone-default-rtdb.asia-southeast1.firebasedatabase.app/",projectId:"parkifycapstone",storageBucket:"parkifycapstone.firebasestorage.app",messagingSenderId:"578453779700",appId:"1:578453779700:web:c34c4202c53b2152bc1aa1",measurementId:"G-5NCE2MM3PM"};

const app=initializeApp(firebaseConfig); const db=getDatabase(app);
const slotsContainer=document.getElementById("slotsContainer");
const FLOOR_NAME="Floor2"; const userID=localStorage.getItem("userID"); const userName=localStorage.getItem("userName")||"Parkify User";

const reservationTimers={}; const countdownIntervals={};

// --- Real-time listener ---
const slotsRef=ref(db,`parkingSlots/parkingSlots/${FLOOR_NAME}/slots`);
onValue(slotsRef,snapshot=>{
    const slotsData=snapshot.val()||{};
    const existingSlotIds=new Set(Array.from(slotsContainer.children).map(c=>c.id.replace('slot-','')));
    const newSlotIds=new Set(Object.keys(slotsData));

    Object.keys(slotsData).forEach(slotId=>{
        const slot=slotsData[slotId]; let status=(slot.status||"unknown").toLowerCase();
        let card=document.getElementById(`slot-${slotId}`); let mustReRenderContent=false;
        let statusClass="",iconHtml="",countdownHtml="";

        if(status==="available"){statusClass="slot-available";iconHtml="‚úÖ"; if(reservationTimers[slotId]){clearTimeout(reservationTimers[slotId]);delete reservationTimers[slotId];} if(countdownIntervals[slotId]){clearInterval(countdownIntervals[slotId]);delete countdownIntervals[slotId];} mustReRenderContent=true;}
        else if(status==="reserved"){
    statusClass="slot-reserved";
    iconHtml="‚è≥";

    // Clear existing timers
    if(reservationTimers[slotId]) { clearTimeout(reservationTimers[slotId]); delete reservationTimers[slotId]; }
    if(countdownIntervals[slotId]) { clearInterval(countdownIntervals[slotId]); delete countdownIntervals[slotId]; }

    // Start countdown from 10s
    let remaining = 10;
    countdownHtml = `<span class="countdown">${remaining}s</span>`;
    mustReRenderContent = true;

    // Update DOM immediately
    if(!card) card = document.createElement("div");

    // Interval to update countdown every second
    countdownIntervals[slotId] = setInterval(() => {
        remaining--;
        const elem = document.querySelector(`#slot-${slotId} .countdown`);
        if(elem) elem.textContent = remaining + "s";
        if(remaining <= 0){
            clearInterval(countdownIntervals[slotId]);
            delete countdownIntervals[slotId];
        }
    }, 1000);

    // Auto-release slot after 10s
    reservationTimers[slotId] = setTimeout(async () => {
        try{
            await update(ref(db,`parkingSlots/parkingSlots/${FLOOR_NAME}/slots/${slotId}`),{
                status:"available",
                lastUpdated:serverTimestamp()
            });
            await logAction("slot_auto_released",`${slot.slotName||slotId} auto-released after 10s`);
        }catch(e){ console.error(e); }
        finally{
            if(countdownIntervals[slotId]) { clearInterval(countdownIntervals[slotId]); delete countdownIntervals[slotId]; }
            delete reservationTimers[slotId];
        }
    }, remaining * 1000);
}

        else if(status==="occupied"){statusClass="slot-occupied";iconHtml="‚ùå"; if(reservationTimers[slotId]){clearTimeout(reservationTimers[slotId]);delete reservationTimers[slotId];} if(countdownIntervals[slotId]){clearInterval(countdownIntervals[slotId]);delete countdownIntervals[slotId];} mustReRenderContent=true;}

        const newContent=`<h3>${slot.slotName||slotId}</h3><span class="status-icon">${iconHtml}</span><p>${status.toUpperCase()}</p>${countdownHtml}`;

        if(!card){card=document.createElement("div");card.id=`slot-${slotId}`;card.classList.add("slot-card");slotsContainer.appendChild(card); mustReRenderContent=true;}
        card.className="slot-card "+statusClass;
        if(mustReRenderContent) card.innerHTML=newContent;

        const oldListener=card.listener; if(oldListener) card.removeEventListener("click",oldListener);
        if(status==="available"){card.style.cursor="pointer"; const newListener=()=>reserveSlot(slotId,slot.slotName||slotId); card.addEventListener("click",newListener); card.listener=newListener;}
        else card.style.cursor="not-allowed";
    });

    existingSlotIds.forEach(slotId=>{if(!newSlotIds.has(slotId)){const c=document.getElementById(`slot-${slotId}`);if(c){c.remove(); if(reservationTimers[slotId]) clearTimeout(reservationTimers[slotId]); if(countdownIntervals[slotId]) clearInterval(countdownIntervals[slotId]); delete reservationTimers[slotId]; delete countdownIntervals[slotId];}}});
});

// --- Reserve Slot ---
async function reserveSlot(slotId,slotName){const isConfirmed=await showConfirmModal(`Reserve ${slotName} for ${userName}?`); if(!isConfirmed)return; const slotRef=ref(db,`parkingSlots/parkingSlots/${FLOOR_NAME}/slots/${slotId}`); const userRef=userID?ref(db,`users/users/${userID}`):null;
try{await update(slotRef,{status:"reserved",userID:userID||"TEMP_USER_"+Date.now(),userName,reservedAt:serverTimestamp(),lastUpdated:serverTimestamp()}); if(userRef) await update(userRef,{selectedFloor:FLOOR_NAME,selectedSlot:slotName,lastReservation:serverTimestamp()}); await logAction("slot_reserved",`${userName} reserved ${slotName}`);}catch(e){console.error(e);showMessage("Failed to reserve slot","error");}}

// --- Log Helper ---
async function logAction(action,details){const logsRef=ref(db,"logs/logs");const newLogRef=push(logsRef);await set(newLogRef,{action,details,timestamp:serverTimestamp(),userID:userID||"SYSTEM"});}
</script>
</body>
</html>

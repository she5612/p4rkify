<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parkify - Choose Floor</title>
    <link rel="stylesheet" href="../css/chooseFloor.css">
</head>
<body>
    <div class="centered-wrapper">
        <header class="app-header">
            <h1>MARKET PARKING AREA üÖøÔ∏è</h1> 
            <p>Tap a floor to check available spots and reserve.</p>
        </header>
        
        <div id="floorsContainer" class="floors-grid"></div>
    </div>

<script type="module">
console.log("ChooseFloor.js loaded!");

// ---------------- FIREBASE IMPORTS ----------------
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getDatabase, ref, get, update, push, set, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

// ---------------- FIREBASE CONFIG ----------------
const firebaseConfig = {
  apiKey: "AIzaSyDWoFHHXKxEMBk-ZhZgYstPV6fylL8SLiE",
  authDomain: "parkifycapstone.firebaseapp.com",
  databaseURL: "https://parkifycapstone-default-rtdb.asia-southeast1.firebasedatabase.app/",
  projectId: "parkifycapstone",
  storageBucket: "parkifycapstone.firebasestorage.app",
  messagingSenderId: "578453779700",
  appId: "1:578453779700:web:c34c4202c53b2152bc1aa1",
  measurementId: "G-5NCE2MM3PM"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// DOM element
const floorsContainer = document.getElementById("floorsContainer");

// Get current user info from localStorage
const userID = localStorage.getItem("userID");
const userName = localStorage.getItem("userName") || "Parkify User";

// ---------------- RENDER FLOORS ----------------
async function renderFloors() {
  floorsContainer.innerHTML = "";

  try {
    const floorsSnap = await get(ref(db, "parkingSlots/parkingSlots"));
    const floorsData = floorsSnap.val();

    if (!floorsData) {
      floorsContainer.innerHTML = "<p>No floors found.</p>";
      return;
    }

    for (const floorName in floorsData) {
      const floor = floorsData[floorName];
      const slots = floor.slots || {};
      const slotKeys = Object.keys(slots);

      // Count available slots
      const availableCount = slotKeys.filter(key => slots[key].status === "available").length;

      // Determine card class
      let cardClass = "floor-card";
      if (availableCount === 0) cardClass += " full";
      else if (availableCount < slotKeys.length) cardClass += " partial";

      // Create floor card
      const card = document.createElement("div");
      card.className = cardClass;
      card.innerHTML = `
        <h2>${floorName}</h2>
        <p>${availableCount > 0 ? availableCount + " Spots Available" : "Full"}</p>
        <button ${availableCount === 0 ? "disabled" : ""}>Reserve Now</button>
      `;

      // Button click handler
      const btn = card.querySelector("button");
      if (availableCount > 0) {
        btn.addEventListener("click", async () => {
          // Save selected floor locally
          localStorage.setItem("selectedFloor", floorName);

          // Update user in Realtime Database
          if (userID) {
            try {
              await update(ref(db, `users/users/${userID}`), {
                selectedFloor: floorName,
                lastReservation: Date.now()
              });
              console.log(`User ${userID}'s selected floor updated to ${floorName}`);

              // ---------------- LOG ENTRY ----------------
              const logsRef = ref(db, "logs/logs");
              const newLogRef = push(logsRef);
              await set(newLogRef, {
                action: "floor_selected",
                details: `${userName} selected ${floorName}`,
                timestamp: serverTimestamp(),
                userID: userID
              });
              console.log("Log saved for floor selection.");

            } catch (err) {
              console.error("Error updating user floor:", err);
            }
          } else {
            console.warn("No userID found in localStorage. Cannot track user.");
          }

          // Redirect to floor page
          window.location.href = `${floorName.toLowerCase()}.html`;

        });
      }

      floorsContainer.appendChild(card);
    }

  } catch (error) {
    console.error("Error fetching floors:", error);
    floorsContainer.innerHTML = "<p>Error loading floors. Please check your connection.</p>";
  }
}

// Load floors on page load
renderFloors();

</script>

</body>
</html>
